name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/rental-landing:latest

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          if [ -n "${{ secrets.SSH_PASSPHRASE }}" ]; then
            sudo apt-get update -qq
            sudo apt-get install -y -qq sshpass
            echo "${{ secrets.SSH_PASSPHRASE }}" > ~/.ssh/passphrase
            chmod 600 ~/.ssh/passphrase
          fi

      - name: Test SSH connection
        timeout-minutes: 2
        run: |
          SSH_OPTS="-o StrictHostKeyChecking=no -o ConnectTimeout=10 -o ServerAliveInterval=60 -o ServerAliveCountMax=3"
          if [ -n "${{ secrets.SSH_PASSPHRASE }}" ]; then
            timeout 30 sshpass -f ~/.ssh/passphrase ssh $SSH_OPTS -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'echo "SSH connection successful"'
          else
            timeout 30 ssh $SSH_OPTS -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'echo "SSH connection successful"'
          fi

      - name: Deploy to VPS
        timeout-minutes: 10
        run: |
          cat > /tmp/deploy.sh << 'SCRIPT'
          set -e
          DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
          DOCKER_TOKEN="${{ secrets.DOCKER_TOKEN }}"
          
          echo "Logging in to Docker Hub..."
          echo "$DOCKER_TOKEN" | timeout 30 docker login -u "$DOCKER_USERNAME" --password-stdin || true
          
          echo "Getting old image ID..."
          OLD_IMAGE=$(docker images $DOCKER_USERNAME/rental-landing --format "{{.ID}}" | tail -n +2 | head -n 1 || true)
          
          echo "Pulling latest image..."
          timeout 300 docker pull $DOCKER_USERNAME/rental-landing:latest || exit 1
          
          echo "Stopping old container..."
          docker stop rental-landing 2>/dev/null || true
          sleep 2
          docker rm rental-landing 2>/dev/null || true
          
          echo "Starting new container..."
          docker run -d \
            --name rental-landing \
            --restart unless-stopped \
            -p 3000:3000 \
            -e NODE_ENV=production \
            $DOCKER_USERNAME/rental-landing:latest || exit 1
          
          echo "Removing old image..."
          if [ ! -z "$OLD_IMAGE" ]; then
            docker rmi $OLD_IMAGE 2>/dev/null || true
          fi
          
          echo "Cleaning up unused images..."
          docker image prune -f || true
          echo "Deployment completed successfully"
          SCRIPT
          
          SSH_OPTS="-o StrictHostKeyChecking=no -o ConnectTimeout=10 -o ServerAliveInterval=60 -o ServerAliveCountMax=3"
          
          if [ -n "${{ secrets.SSH_PASSPHRASE }}" ]; then
            timeout 600 sshpass -f ~/.ssh/passphrase ssh $SSH_OPTS -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'bash -s' < /tmp/deploy.sh
          else
            timeout 600 ssh $SSH_OPTS -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'bash -s' < /tmp/deploy.sh
          fi

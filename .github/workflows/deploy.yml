name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/rental-landing:latest

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 600 ~/.ssh/known_hosts
          if [ -n "${{ secrets.SSH_PASSPHRASE }}" ]; then
            sudo apt-get update -qq
            sudo apt-get install -y -qq expect
          fi

      - name: Deploy to VPS
        timeout-minutes: 15
        run: |
          cat > /tmp/deploy.sh << 'SCRIPT'
          set -e
          DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
          DOCKER_TOKEN="${{ secrets.DOCKER_TOKEN }}"
          
          echo "=== Starting Deployment ==="
          echo "Logging in to Docker Hub..."
          echo "$DOCKER_TOKEN" | timeout 30 docker login -u "$DOCKER_USERNAME" --password-stdin || {
            echo "ERROR: Docker login failed"
            exit 1
          }
          
          echo "Getting old image ID..."
          OLD_IMAGE=$(docker images $DOCKER_USERNAME/rental-landing --format "{{.ID}}" | tail -n +2 | head -n 1 || true)
          echo "Old image ID: ${OLD_IMAGE:-none}"
          
          echo "Pulling latest image..."
          timeout 300 docker pull $DOCKER_USERNAME/rental-landing:latest || {
            echo "ERROR: Docker pull failed"
            exit 1
          }
          
          echo "Stopping old container..."
          docker stop rental-landing 2>/dev/null || echo "No existing container to stop"
          sleep 2
          docker rm rental-landing 2>/dev/null || echo "No existing container to remove"
          
          echo "Starting new container..."
          CONTAINER_ID=$(docker run -d \
            --name rental-landing \
            --restart unless-stopped \
            -p 3000:3000 \
            -e NODE_ENV=production \
            $DOCKER_USERNAME/rental-landing:latest) || {
            echo "ERROR: Failed to start container"
            exit 1
          }
          echo "Container started with ID: $CONTAINER_ID"
          
          echo "Checking container status..."
          sleep 3
          docker ps | grep rental-landing || {
            echo "WARNING: Container not found in running containers"
            echo "Checking all containers..."
            docker ps -a | grep rental-landing || {
              echo "ERROR: Container not found at all"
              exit 1
            }
            echo "Container exists but is not running. Checking logs..."
            docker logs rental-landing || true
            exit 1
          }
          
          echo "Removing old image..."
          if [ ! -z "$OLD_IMAGE" ]; then
            docker rmi $OLD_IMAGE 2>/dev/null || echo "Could not remove old image"
          fi
          
          echo "Cleaning up unused images..."
          docker image prune -f || true
          echo "=== Deployment completed successfully ==="
          SCRIPT
          
          SSH_OPTS="-o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3"
          
          echo "Connecting to VPS..."
          if [ -n "${{ secrets.SSH_PASSPHRASE }}" ]; then
            DEPLOY_SCRIPT_CONTENT=$(cat /tmp/deploy.sh)
            printf 'set timeout 600\n' > /tmp/ssh_expect.exp
            printf 'set passphrase "%s"\n' "${{ secrets.SSH_PASSPHRASE }}" >> /tmp/ssh_expect.exp
            printf 'log_user 1\n' >> /tmp/ssh_expect.exp
            printf 'spawn ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 -i ~/.ssh/deploy_key %s@%s bash -s\n' "${{ secrets.VPS_USER }}" "${{ secrets.VPS_HOST }}" >> /tmp/ssh_expect.exp
            printf 'expect {\n' >> /tmp/ssh_expect.exp
            printf '  "Enter passphrase for key" { send "$passphrase\\r"; exp_continue }\n' >> /tmp/ssh_expect.exp
            printf '  "passphrase:" { send "$passphrase\\r"; exp_continue }\n' >> /tmp/ssh_expect.exp
            printf '  timeout { puts "Connection timeout"; exit 1 }\n' >> /tmp/ssh_expect.exp
            printf '  -re ".+"\n' >> /tmp/ssh_expect.exp
            printf '}\n' >> /tmp/ssh_expect.exp
            printf 'send [read [open "/tmp/deploy.sh" r]]\n' >> /tmp/ssh_expect.exp
            printf 'send "\\x04"\n' >> /tmp/ssh_expect.exp
            printf 'expect {\n' >> /tmp/ssh_expect.exp
            printf '  eof\n' >> /tmp/ssh_expect.exp
            printf '}\n' >> /tmp/ssh_expect.exp
            printf 'set exit_code [lindex [wait] 3]\n' >> /tmp/ssh_expect.exp
            printf 'exit $exit_code\n' >> /tmp/ssh_expect.exp
            expect /tmp/ssh_expect.exp || exit 1
          else
            ssh $SSH_OPTS -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} 'bash -s' < /tmp/deploy.sh || exit 1
          fi
          
          echo "Verifying container status..."
          if [ -n "${{ secrets.SSH_PASSPHRASE }}" ]; then
            printf 'set timeout 30\n' > /tmp/verify.exp
            printf 'set passphrase "%s"\n' "${{ secrets.SSH_PASSPHRASE }}" >> /tmp/verify.exp
            printf 'log_user 1\n' >> /tmp/verify.exp
            printf 'spawn ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -i ~/.ssh/deploy_key %s@%s "docker ps -a | grep rental-landing"\n' "${{ secrets.VPS_USER }}" "${{ secrets.VPS_HOST }}" >> /tmp/verify.exp
            printf 'expect {\n' >> /tmp/verify.exp
            printf '  "Enter passphrase for key" { send "$passphrase\\r"; exp_continue }\n' >> /tmp/verify.exp
            printf '  "passphrase:" { send "$passphrase\\r"; exp_continue }\n' >> /tmp/verify.exp
            printf '  eof\n' >> /tmp/verify.exp
            printf '}\n' >> /tmp/verify.exp
            expect /tmp/verify.exp
          else
            ssh $SSH_OPTS -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "docker ps -a | grep rental-landing"
          fi
